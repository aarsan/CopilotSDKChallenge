<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfraForge ‚Äî Self-Service Infrastructure Platform</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="/static/styles.css?v=53">
    <!-- Mermaid for architecture diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <!-- Marked for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/bash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/lib/languages/powershell.min.js"></script>
    <script>
        hljs.registerAliases(['bicep', 'terraform', 'hcl', 'tf'], { languageName: 'bash' });
    </script>
</head>
<body>
    <!-- ‚îÄ‚îÄ Login Screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="login-screen" class="screen">
        <div class="login-container">
            <div class="login-logo">
                <span class="logo-icon">‚öíÔ∏è</span>
                <h1>InfraForge</h1>
                <p class="tagline">Self-Service Infrastructure Platform</p>
            </div>
            <div class="login-card">
                <p class="login-description">
                    Provision production-ready cloud infrastructure through natural language.
                    Sign in with your corporate account to get started.
                </p>
                <button id="btn-login" class="btn btn-primary btn-login" onclick="doLogin()">
                    <svg class="ms-icon" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
                        <rect x="1" y="1" width="9" height="9" fill="#f25022"/>
                        <rect x="11" y="1" width="9" height="9" fill="#7fba00"/>
                        <rect x="1" y="11" width="9" height="9" fill="#00a4ef"/>
                        <rect x="11" y="11" width="9" height="9" fill="#ffb900"/>
                    </svg>
                    Sign in with Microsoft
                </button>
                <div id="login-error" class="login-error hidden"></div>
                <p class="login-note">
                    Your identity is used to auto-tag infrastructure, route approvals,
                    and track cost attribution across your organization.
                </p>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="app-screen" class="screen hidden">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="logo-icon-sm">‚öíÔ∏è</span>
                <span class="sidebar-title">InfraForge</span>
            </div>

            <!-- User Info -->
            <div class="user-card">
                <div class="user-avatar" id="user-avatar">AJ</div>
                <div class="user-info">
                    <div class="user-name" id="user-name">Alex Johnson</div>
                    <div class="user-role" id="user-role">Cloud Engineer</div>
                    <div class="user-dept" id="user-dept">Engineering ¬∑ CC-ENG-4200</div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="sidebar-nav">
                <div class="nav-section-title">Navigation</div>
                <button class="nav-btn active" id="nav-dashboard" onclick="navigateTo('dashboard')">
                    <span class="nav-icon">üè†</span> Dashboard
                </button>
                <button class="nav-btn" id="nav-services" onclick="navigateTo('services')">
                    <span class="nav-icon">üìã</span> Service Catalog
                </button>
                <button class="nav-btn" id="nav-templates" onclick="navigateTo('templates')">
                    <span class="nav-icon">üì¶</span> Templates
                </button>
                <button class="nav-btn" id="nav-governance" onclick="navigateTo('governance')">
                    <span class="nav-icon">üìú</span> Governance
                </button>
                <button class="nav-btn" id="nav-activity" onclick="navigateTo('activity')">
                    <span class="nav-icon">üì°</span> Observability
                    <span class="nav-badge" id="nav-activity-badge" style="display:none"></span>
                </button>
                <button class="nav-btn" id="nav-chat" onclick="navigateTo('chat')">
                    <span class="nav-icon">üí¨</span> Infrastructure Designer
                </button>

                <div class="nav-section-title" style="margin-top: 0.5rem">Quick Design</div>
                <button class="nav-btn" onclick="navigateToChat('Create a 3-tier web application with App Service, SQL Database, and Key Vault')">
                    <span class="nav-icon">üèóÔ∏è</span> New Web App
                </button>
                <button class="nav-btn" onclick="navigateToChat('Generate a GitHub Actions CI/CD pipeline for a Python web application')">
                    <span class="nav-icon">üîÑ</span> New Pipeline
                </button>
                <button class="nav-btn" onclick="navigateToChat('Create a microservices architecture with AKS, Container Registry, and API Management')">
                    <span class="nav-icon">üê≥</span> New Microservices
                </button>

                <div class="nav-section-title" style="margin-top: 0.5rem">Review</div>
                <button class="nav-btn" onclick="navigateToChat('Estimate costs for my current infrastructure request')">
                    <span class="nav-icon">üí∞</span> Cost Estimate
                </button>
                <button class="nav-btn" onclick="navigateToChat('Run a policy compliance check on the last generated infrastructure')">
                    <span class="nav-icon">üõ°Ô∏è</span> Policy Check
                </button>
                <button class="nav-btn" onclick="navigateToChat('Generate an architecture diagram for the infrastructure we discussed')">
                    <span class="nav-icon">üìä</span> Architecture Diagram
                </button>

                <div class="nav-section-title" style="margin-top: 0.5rem">Documentation</div>
                <a class="nav-btn" href="/onboarding-docs" target="_blank" style="text-decoration:none;color:inherit">
                    <span class="nav-icon">üìñ</span> Onboarding Pipeline
                </a>
                <a class="nav-btn" href="/docs" target="_blank" style="text-decoration:none;color:inherit">
                    <span class="nav-icon">üîå</span> API Reference
                </a>
            </nav>

            <!-- Session Info -->
            <div class="sidebar-footer">
                <div class="session-badge" id="session-badge">
                    <span class="status-dot connected"></span> Connected
                </div>
                <button class="btn btn-sm btn-secondary" onclick="doLogout()">Sign Out</button>
            </div>
        </aside>

        <!-- ‚ïê‚ïê‚ïê Main Content Area ‚ïê‚ïê‚ïê -->
        <main class="main-content">
            <!-- Content Header -->
            <div class="content-header">
                <div class="content-header-left">
                    <h2 id="page-title">Dashboard</h2>
                    <span class="powered-by" id="page-subtitle">Powered by GitHub Copilot SDK</span>
                </div>
                <div class="content-header-right" id="page-actions"></div>
            </div>

            <!-- ‚ïê‚ïê‚ïê PAGE: Dashboard ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="page page-scroll" id="page-dashboard">
                <div class="page-inner">
                    <!-- Stats Bar -->
                    <div class="dashboard-stats" id="dashboard-stats">
                        <div class="stat-card clickable" onclick="navigateTo('services')">
                            <div class="stat-number" id="stat-approved">‚Äî</div>
                            <div class="stat-label">Approved Services</div>
                        </div>
                        <div class="stat-card clickable" onclick="navigateTo('templates')">
                            <div class="stat-number" id="stat-templates">‚Äî</div>
                            <div class="stat-label">Catalog Templates</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="stat-conditional">‚Äî</div>
                            <div class="stat-label">Conditional</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="stat-review">‚Äî</div>
                            <div class="stat-label">Under Review</div>
                        </div>
                        <div class="stat-card clickable" onclick="navigateTo('activity')" title="View Observability">
                            <div class="stat-number stat-validating" id="stat-validating">‚Äî</div>
                            <div class="stat-label">Validating</div>
                        </div>
                    </div>

                    <!-- Design Mode Selector -->
                    <div class="dashboard-section">
                        <h3 class="section-title">Design Mode</h3>
                        <p class="section-desc">Choose how InfraForge generates your infrastructure designs.</p>
                        <div class="design-mode-toggle">
                            <button class="mode-card active" id="mode-approved" onclick="setDesignMode('approved')">
                                <span class="mode-icon">üõ°Ô∏è</span>
                                <span class="mode-name">Approved Only</span>
                                <span class="mode-desc">Build only with pre-approved services. Deploy immediately with full governance compliance.</span>
                                <span class="mode-badge badge-approved">Default ¬∑ Deploy Now</span>
                            </button>
                            <button class="mode-card" id="mode-ideal" onclick="setDesignMode('ideal')">
                                <span class="mode-icon">üöÄ</span>
                                <span class="mode-name">Ideal Design</span>
                                <span class="mode-desc">Best-practice architecture regardless of approval status. Non-approved services trigger guided approval requests.</span>
                                <span class="mode-badge badge-ideal">Requires Approval</span>
                            </button>
                        </div>
                        <div class="mode-info" id="mode-info">
                            <span class="mode-info-icon">‚ÑπÔ∏è</span>
                            <span class="mode-info-text">Approved Only mode: All generated infrastructure uses services vetted by the platform team. Ready to deploy.</span>
                        </div>
                    </div>

                    <!-- Approval Request Tracker -->
                    <div class="dashboard-section" id="approval-tracker-section">
                        <h3 class="section-title">Approval Requests</h3>
                        <p class="section-desc">Track the status of services submitted for IT approval.</p>
                        <div id="approval-tracker">
                            <div class="approval-empty">
                                <span class="approval-empty-icon">üìã</span>
                                <p>No approval requests yet. When you use <strong>Ideal Design</strong> mode, non-approved services will be submitted here for IT review.</p>
                            </div>
                        </div>
                        <div class="workflow-explainer">
                            <h4 class="workflow-title">How Service Approval Works</h4>
                            <div class="workflow-steps">
                                <div class="workflow-step">
                                    <span class="workflow-step-num">1</span>
                                    <span class="workflow-step-icon">üì®</span>
                                    <span class="workflow-step-text">Submit Request</span>
                                </div>
                                <div class="workflow-arrow">‚Üí</div>
                                <div class="workflow-step">
                                    <span class="workflow-step-num">2</span>
                                    <span class="workflow-step-icon">üîç</span>
                                    <span class="workflow-step-text">IT Review</span>
                                </div>
                                <div class="workflow-arrow">‚Üí</div>
                                <div class="workflow-step step-branch">
                                    <span class="workflow-step-num">3</span>
                                    <span class="workflow-step-icon">‚úÖ</span>
                                    <span class="workflow-step-text">Approved / ‚ö†Ô∏è Conditional / ‚ùå Denied</span>
                                </div>
                                <div class="workflow-arrow">‚Üí</div>
                                <div class="workflow-step">
                                    <span class="workflow-step-num">4</span>
                                    <span class="workflow-step-icon">üöÄ</span>
                                    <span class="workflow-step-text">Deploy</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Capabilities Grid -->
                    <div class="dashboard-section">
                        <h3 class="section-title">What I Can Do</h3>
                        <div class="capabilities-grid">
                            <button class="capability-card" onclick="navigateTo('services')">
                                <span class="cap-icon">üìã</span>
                                <span class="cap-title">Service Catalog</span>
                                <span class="cap-desc">Browse all approved Azure services, policies, and SKUs</span>
                            </button>
                            <button class="capability-card" onclick="navigateTo('templates')">
                                <span class="cap-icon">üì¶</span>
                                <span class="cap-title">Template Catalog</span>
                                <span class="cap-desc">Find pre-approved, tested infrastructure modules</span>
                            </button>
                            <button class="capability-card" onclick="navigateToChat('Generate Bicep for a production web app with SQL backend')">
                                <span class="cap-icon">‚öôÔ∏è</span>
                                <span class="cap-title">Generate IaC</span>
                                <span class="cap-desc">Bicep or Terraform from natural language</span>
                            </button>
                            <button class="capability-card" onclick="navigateToChat('Generate a CI/CD pipeline for deploying my infrastructure')">
                                <span class="cap-icon">üîÑ</span>
                                <span class="cap-title">CI/CD Pipelines</span>
                                <span class="cap-desc">GitHub Actions &amp; Azure DevOps YAML</span>
                            </button>
                            <button class="capability-card" onclick="navigateToChat('Generate an architecture diagram for a 3-tier web application')">
                                <span class="cap-icon">üìä</span>
                                <span class="cap-title">Architecture Diagrams</span>
                                <span class="cap-desc">Mermaid diagrams for stakeholder review</span>
                            </button>
                            <button class="capability-card" onclick="navigateToChat('Estimate monthly Azure costs for an App Service + SQL Database setup')">
                                <span class="cap-icon">üí∞</span>
                                <span class="cap-title">Cost Estimation</span>
                                <span class="cap-desc">Monthly spend projections before provisioning</span>
                            </button>
                            <button class="capability-card" onclick="navigateToChat('Run a policy compliance check on my infrastructure')">
                                <span class="cap-icon">üõ°Ô∏è</span>
                                <span class="cap-title">Policy Compliance</span>
                                <span class="cap-desc">Validate against organizational governance</span>
                            </button>
                            <button class="capability-card" onclick="navigateToChat('Generate a design document for production approval')">
                                <span class="cap-icon">üìù</span>
                                <span class="cap-title">Design Documents</span>
                                <span class="cap-desc">Approval-ready artifacts with full context</span>
                            </button>
                        </div>
                    </div>

                    <!-- Quick Start Prompts -->
                    <div class="dashboard-section">
                        <h3 class="section-title">Try These</h3>
                        <div class="example-prompts">
                            <button class="example-prompt" onclick="navigateToChat(this.dataset.prompt)" data-prompt="I need a production-ready 3-tier web application with App Service, SQL Database, Key Vault, and Application Insights">
                                <span class="example-icon">üèóÔ∏è</span>
                                <span>"I need a production-ready 3-tier web app with database and monitoring"</span>
                            </button>
                            <button class="example-prompt" onclick="navigateToChat(this.dataset.prompt)" data-prompt="What services are approved for building a data pipeline with Event Hub and Cosmos DB?">
                                <span class="example-icon">‚ùì</span>
                                <span>"What services are approved for a data pipeline?"</span>
                            </button>
                            <button class="example-prompt" onclick="navigateToChat(this.dataset.prompt)" data-prompt="Create a microservices setup with AKS, Container Registry, and API Management, then generate an architecture diagram and cost estimate">
                                <span class="example-icon">üê≥</span>
                                <span>"Create a microservices setup with AKS and give me the diagram + costs"</span>
                            </button>
                            <button class="example-prompt" onclick="navigateToChat(this.dataset.prompt)" data-prompt="Generate a GitHub Actions pipeline with dev/staging/prod stages, approval gates, and security scanning for a Node.js application">
                                <span class="example-icon">üîÑ</span>
                                <span>"Generate a multi-stage CI/CD pipeline with approval gates"</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê PAGE: Service Catalog ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="page page-scroll hidden" id="page-services">
                <div class="page-inner">
                    <!-- Azure Services Stats Panel -->
                    <div class="service-stats-panel" id="service-stats-panel">
                        <div class="service-stats-cards">
                            <div class="svc-stat-card">
                                <div class="svc-stat-icon">üåê</div>
                                <div class="svc-stat-body">
                                    <div class="svc-stat-number" id="svc-stat-azure">‚Äî</div>
                                    <div class="svc-stat-label">Azure Services</div>
                                    <div class="svc-stat-sublabel">Available in ARM</div>
                                </div>
                            </div>
                            <div class="svc-stat-card">
                                <div class="svc-stat-icon">üíæ</div>
                                <div class="svc-stat-body">
                                    <div class="svc-stat-number" id="svc-stat-cached">‚Äî</div>
                                    <div class="svc-stat-label">Cached in System</div>
                                    <div class="svc-stat-sublabel">In InfraForge catalog</div>
                                </div>
                            </div>
                            <div class="svc-stat-card">
                                <div class="svc-stat-icon">‚úÖ</div>
                                <div class="svc-stat-body">
                                    <div class="svc-stat-number" id="svc-stat-approved">‚Äî</div>
                                    <div class="svc-stat-label">Approved</div>
                                    <div class="svc-stat-sublabel">Ready to provision</div>
                                </div>
                            </div>
                            <div class="svc-stat-card svc-stat-sync-card">
                                <div class="svc-stat-icon" id="svc-sync-icon">üîÑ</div>
                                <div class="svc-stat-body">
                                    <div class="svc-stat-status" id="svc-sync-status">Never synced</div>
                                    <div class="svc-stat-label">Sync Status</div>
                                    <div class="svc-stat-sublabel" id="svc-sync-detail">Pull services from Azure</div>
                                </div>
                                <button class="btn btn-sm btn-sync" id="btn-sync-panel" onclick="syncAzureServices()" title="Sync from Azure">
                                    <span class="sync-btn-icon">‚ü≥</span> Sync
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="page-toolbar">
                        <div class="page-search">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="service-search" placeholder="Search services by name or ID..." oninput="searchServices(this.value)" />
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="filter-bar">
                        <div class="filter-group">
                            <span class="filter-label">Category</span>
                            <div class="catalog-filters" id="catalog-filters">
                                <button class="filter-pill active" onclick="filterServices('all')">All</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Status</span>
                            <div class="catalog-filters" id="status-filters">
                                <button class="filter-pill active" onclick="filterServicesByStatus('all')">All</button>
                                <button class="filter-pill" onclick="filterServicesByStatus('approved')">‚úÖ Approved</button>
                                <button class="filter-pill" onclick="filterServicesByStatus('conditional')">‚ö†Ô∏è Conditional</button>
                                <button class="filter-pill" onclick="filterServicesByStatus('under_review')">üîÑ Under Review</button>
                                <button class="filter-pill" onclick="filterServicesByStatus('validating')">‚è≥ Validating</button>
                                <button class="filter-pill" onclick="filterServicesByStatus('validation_failed')">‚õî Failed</button>
                                <button class="filter-pill" onclick="filterServicesByStatus('not_approved')">‚ùå Not Approved</button>
                            </div>
                        </div>
                    </div>

                    <!-- Results Summary -->
                    <div class="results-summary" id="service-results-summary"></div>

                    <!-- Service Table -->
                    <div class="catalog-table-wrap full-height">
                        <table class="catalog-table" id="catalog-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Category</th>
                                    <th>Version</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="catalog-tbody">
                                <tr><td colspan="4" class="catalog-loading">Loading services...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê PAGE: Template Catalog ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="page page-scroll hidden" id="page-templates">
                <div class="page-inner">
                    <!-- Search -->
                    <div class="page-toolbar">
                        <div class="page-search">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="template-search" placeholder="Search templates by name, tag, or resource type..." oninput="searchTemplates(this.value)" />
                        </div>
                    </div>

                    <!-- Type Filters -->
                    <div class="filter-bar">
                        <div class="filter-group">
                            <span class="filter-label">Type</span>
                            <div class="catalog-filters" id="template-type-filters">
                                <button class="filter-pill active" onclick="filterTemplateType('all')">All</button>
                                <button class="filter-pill" onclick="filterTemplateType('foundation')">üèóÔ∏è Foundation</button>
                                <button class="filter-pill" onclick="filterTemplateType('workload')">‚öôÔ∏è Workload</button>
                                <button class="filter-pill" onclick="filterTemplateType('composite')">üì¶ Composite</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Format</span>
                            <div class="catalog-filters" id="template-filters">
                                <button class="filter-pill active" onclick="filterTemplates('all')">All</button>
                            </div>
                        </div>
                    </div>

                    <!-- Results Summary -->
                    <div class="results-summary" id="template-results-summary"></div>

                    <!-- Template Cards (replaces flat table for better dependency visibility) -->
                    <div class="template-cards-grid" id="template-cards-grid">
                        <div class="catalog-loading">Loading templates...</div>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê PAGE: Governance Standards ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="page page-scroll hidden" id="page-governance">
                <div class="page-inner">
                    <!-- Search -->
                    <div class="page-toolbar">
                        <div class="page-search">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="standards-search" placeholder="Search standards by name, category, or ID..." oninput="searchStandards(this.value)" />
                        </div>
                    </div>

                    <!-- Category Filters -->
                    <div class="filter-bar">
                        <div class="filter-group">
                            <span class="filter-label">Category</span>
                            <div class="catalog-filters" id="standards-category-filters">
                                <button class="filter-pill active" onclick="filterStandards('all')">All</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Severity</span>
                            <div class="catalog-filters" id="standards-severity-filters">
                                <button class="filter-pill active" onclick="filterStandardsBySeverity('all')">All</button>
                                <button class="filter-pill" onclick="filterStandardsBySeverity('critical')">üî¥ Critical</button>
                                <button class="filter-pill" onclick="filterStandardsBySeverity('high')">üü† High</button>
                                <button class="filter-pill" onclick="filterStandardsBySeverity('medium')">üü° Medium</button>
                                <button class="filter-pill" onclick="filterStandardsBySeverity('low')">üü¢ Low</button>
                            </div>
                        </div>
                    </div>

                    <!-- Results Summary -->
                    <div class="results-summary" id="standards-results-summary"></div>

                    <!-- Standards List -->
                    <div class="standards-list" id="standards-list">
                        <div class="catalog-loading">Loading standards...</div>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê PAGE: Observability ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="page page-scroll hidden" id="page-activity">
                <div class="page-inner">
                    <!-- Observability Summary Bar -->
                    <div class="obs-summary" id="obs-summary">
                        <div class="obs-stat">
                            <span class="obs-stat-num" id="obs-deployments-total">0</span>
                            <span class="obs-stat-label">Total Runs</span>
                        </div>
                        <div class="obs-stat">
                            <span class="obs-stat-num obs-stat-ok" id="obs-deployments-succeeded">0</span>
                            <span class="obs-stat-label">Succeeded</span>
                        </div>
                        <div class="obs-stat">
                            <span class="obs-stat-num obs-stat-fail" id="obs-deployments-failed">0</span>
                            <span class="obs-stat-label">Failed</span>
                        </div>
                        <div class="obs-stat">
                            <span class="obs-stat-num activity-pulse" id="activity-running">0</span>
                            <span class="obs-stat-label">Running</span>
                        </div>
                        <div class="obs-stat">
                            <span class="obs-stat-num obs-stat-ok" id="activity-approved">0</span>
                            <span class="obs-stat-label">Validated</span>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="obs-tabs">
                        <button class="obs-tab active" id="obs-tab-deployments" onclick="switchObsTab('deployments')">üöÄ Deployments</button>
                        <button class="obs-tab" id="obs-tab-validations" onclick="switchObsTab('validations')">üî¨ Service Validations</button>
                    </div>

                    <!-- Tab: Deployments -->
                    <div class="obs-tab-content" id="obs-content-deployments">
                        <div class="obs-deploy-feed" id="obs-deploy-feed">
                            <div class="activity-empty">
                                <span class="activity-empty-icon">üöÄ</span>
                                <p>No deployments yet. Deploy a template from the Template Catalog.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Service Validations (existing activity feed) -->
                    <div class="obs-tab-content hidden" id="obs-content-validations">
                        <div class="activity-summary" id="activity-summary">
                            <div class="activity-stat">
                                <span class="activity-stat-num" id="activity-validating">0</span>
                                <span class="activity-stat-label">Awaiting</span>
                            </div>
                            <div class="activity-stat">
                                <span class="activity-stat-num activity-stat-fail" id="activity-failed">0</span>
                                <span class="activity-stat-label">Failed</span>
                            </div>
                        </div>
                        <div class="activity-feed" id="activity-feed">
                            <div class="activity-empty">
                                <span class="activity-empty-icon">üî¨</span>
                                <p>No service validation activity yet. Onboard a service to trigger automated validation.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê PAGE: Chat / Infrastructure Designer ‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="page page-chat hidden" id="page-chat">
                <!-- Messages -->
                <div class="messages-container" id="messages">
                    <!-- Chat Welcome -->
                    <div class="chat-welcome" id="chat-welcome">
                        <div class="chat-welcome-icon">‚öíÔ∏è</div>
                        <h3>Infrastructure Designer</h3>
                        <p>Describe what you need in plain English ‚Äî I'll check governance, search templates, generate IaC, and produce architecture diagrams.</p>
                        <div class="chat-suggestions">
                            <button class="chat-suggestion" onclick="sendQuickAction('I need a production web app with SQL database, Key Vault, and monitoring')">üèóÔ∏è Design a web app</button>
                            <button class="chat-suggestion" onclick="sendQuickAction('Generate a CI/CD pipeline with approval gates for my infrastructure')">üîÑ Create a pipeline</button>
                            <button class="chat-suggestion" onclick="sendQuickAction('Check if App Service, SQL Database, and Key Vault are approved')">üîç Check service approval</button>
                        </div>
                    </div>
                </div>

                <!-- Tool Activity Indicator -->
                <div class="tool-activity hidden" id="tool-activity">
                    <div class="tool-spinner"></div>
                    <span id="tool-activity-text">Searching template catalog...</span>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-wrapper">
                        <textarea
                            id="user-input"
                            placeholder="Describe the infrastructure you need..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResizeTextarea(this)"
                        ></textarea>
                        <button id="btn-send" class="btn btn-send" onclick="sendMessage()" title="Send">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13"></path>
                                <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="input-footer">
                        <span class="input-hint">Press Enter to send ¬∑ Shift+Enter for new line</span>
                        <span class="input-hint" id="user-context-hint"></span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ‚îÄ‚îÄ Service Approval Drawer (3-Gate Workflow) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="service-detail-drawer" class="detail-drawer hidden">
        <div class="detail-drawer-header">
            <h3 id="detail-service-name">Service Name</h3>
            <button class="modal-close" onclick="closeServiceDetail()">√ó</button>
        </div>
        <div class="detail-drawer-body" id="detail-service-body">
            <!-- Populated dynamically by showServiceDetail() -->
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Template Detail Drawer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="template-detail-drawer" class="detail-drawer hidden">
        <div class="detail-drawer-header">
            <h3 id="detail-template-name">Template Name</h3>
            <button class="modal-close" onclick="closeTemplateDetail()">√ó</button>
        </div>
        <div class="detail-drawer-body" id="detail-template-body"></div>
    </div>

    <!-- ‚îÄ‚îÄ Service Governance Editor Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="modal-service-onboard" class="modal-overlay hidden" onclick="closeModalOnOverlay(event, 'modal-service-onboard')">
        <div class="modal-dialog" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>‚öíÔ∏è <span id="governance-modal-title">Approve Service</span></h3>
                <button class="modal-close" onclick="closeModal('modal-service-onboard')">√ó</button>
            </div>
            <form id="form-service-onboard" onsubmit="submitGovernanceUpdate(event)">
                <input type="hidden" name="id" />
                <input type="hidden" name="_action" />
                <div class="modal-body">
                    <!-- Service identity (read-only, pre-filled) -->
                    <div class="governance-service-header" id="governance-svc-header">
                        <div class="svc-name" id="governance-svc-name"></div>
                        <div class="svc-id" id="governance-svc-id"></div>
                        <div class="governance-svc-meta">
                            <span class="category-badge" id="governance-svc-category"></span>
                            <span class="status-badge" id="governance-svc-status"></span>
                        </div>
                    </div>

                    <hr class="form-divider" />

                    <div class="form-group">
                        <label>Policies <span class="hint">(one per line ‚Äî defines allowed regions, SKUs, security requirements)</span></label>
                        <textarea name="policies" rows="5" placeholder="Must use managed identity&#10;HTTPS only&#10;TLS 1.2 minimum&#10;Allowed regions: eastus2, westus3&#10;Allowed SKUs: B1, S1, P1v3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Conditions <span class="hint">(one per line ‚Äî requirements that must be met for approval)</span></label>
                        <textarea name="conditions" rows="3" placeholder="Requires private endpoint in production&#10;Must be deployed via approved CI/CD pipeline&#10;Requires security review for public endpoints"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Documentation URL</label>
                        <input type="url" name="documentation" placeholder="https://learn.microsoft.com/..." />
                    </div>
                    <div class="form-group">
                        <label>Review Notes</label>
                        <textarea name="review_notes" rows="2" placeholder="Internal notes about this approval decision..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-service-onboard')">Cancel</button>
                    <button type="submit" class="btn btn-accent" id="btn-submit-service">‚úÖ Approve Service</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Template Onboarding Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="modal-template-onboard" class="modal-overlay hidden" onclick="closeModalOnOverlay(event, 'modal-template-onboard')">
        <div class="modal-dialog modal-wide" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üì¶ Create Template</h3>
                <button class="modal-close" onclick="closeModal('modal-template-onboard')">√ó</button>
            </div>

            <!-- ‚îÄ‚îÄ Tab Switcher ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="compose-tabs">
                <button class="compose-tab compose-tab-active" id="compose-tab-prompt" onclick="switchComposeTab('prompt')">
                    üí¨ Describe What You Need
                </button>
                <button class="compose-tab" id="compose-tab-manual" onclick="switchComposeTab('manual')">
                    üîß Pick Services Manually
                </button>
            </div>

            <!-- ‚ïê‚ïê‚ïê Tab 1: Prompt-Driven ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="compose-panel-prompt" class="compose-panel">
                <div class="modal-body">
                    <div class="compose-prompt-section">
                        <label class="compose-prompt-label">What infrastructure do you need?</label>
                        <textarea id="compose-prompt-input" class="form-control compose-prompt-textarea"
                            rows="3"
                            placeholder="e.g. I need a VM with a SQL database and Key Vault for secrets management‚Ä¶"></textarea>
                        <div class="compose-prompt-hint">InfraForge will determine the right Azure services, check policies, and compose the template for you.</div>
                    </div>
                    <div id="compose-prompt-policy" class="tmpl-revision-policy" style="display:none;"></div>
                    <div id="compose-prompt-result" style="display:none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-template-onboard')">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btn-prompt-compose" onclick="submitPromptCompose()">
                        üöÄ Create Template
                    </button>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê Tab 2: Manual Service Picker ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div id="compose-panel-manual" class="compose-panel" style="display:none;">
            <form id="form-template-onboard" onsubmit="submitTemplateOnboarding(event)">
                <div class="modal-body">
                    <!-- Step 1: Template basics -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Template Name <span class="required">*</span></label>
                            <input type="text" name="name" required placeholder="e.g. Web App with SQL and Key Vault" />
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select name="category">
                                <option value="blueprint">Blueprint</option>
                                <option value="compute">Compute</option>
                                <option value="database">Database</option>
                                <option value="storage">Storage</option>
                                <option value="networking">Networking</option>
                                <option value="security">Security</option>
                                <option value="monitoring">Monitoring</option>
                                <option value="foundation">Foundation</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" rows="2" placeholder="What this template deploys and key features..."></textarea>
                    </div>

                    <!-- Step 2: Service picker -->
                    <div class="compose-section">
                        <div class="compose-section-header">
                            <span class="compose-section-title">Select Approved Services</span>
                            <span class="compose-section-hint">Only approved, onboarded services with validated ARM templates appear here</span>
                        </div>
                        <div class="compose-service-search">
                            <input type="text" id="compose-service-search" placeholder="üîç Filter services..." oninput="filterComposeServices()" />
                        </div>
                        <div class="compose-service-list" id="compose-service-list">
                            <div class="compose-loading">Loading approved services‚Ä¶</div>
                        </div>
                    </div>

                    <!-- Step 3: Selected services with params -->
                    <div class="compose-section" id="compose-selections-section" style="display:none">
                        <div class="compose-section-header">
                            <span class="compose-section-title">Configure Selected Services</span>
                            <span class="compose-section-hint">Set quantity and choose which parameters to expose in the template</span>
                        </div>
                        <div id="compose-selections"></div>
                    </div>

                    <!-- Step 4: Dependency Analysis Preview -->
                    <div class="compose-section" id="compose-dep-analysis-section" style="display:none">
                        <div class="compose-section-header">
                            <span class="compose-section-title">üìä Dependency Analysis</span>
                            <span class="compose-section-hint">Auto-detected template type and infrastructure requirements</span>
                        </div>
                        <div id="compose-dep-analysis"></div>
                    </div>

                    <!-- Step 5: Test Results (shown after compose) -->
                    <div class="compose-section" id="compose-test-results-section" style="display:none">
                        <div class="compose-section-header">
                            <span class="compose-section-title">üß™ Template Test Results</span>
                            <span class="compose-section-hint">Template must pass all tests before it becomes available in the catalog</span>
                        </div>
                        <div id="compose-test-results"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-template-onboard')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="btn-submit-template" disabled>
                        Create &amp; Test Template
                    </button>
                </div>
            </form>
            </div><!-- /compose-panel-manual -->
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Add / Edit Standard Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="modal-standard" class="modal-overlay hidden" onclick="closeModalOnOverlay(event, 'modal-standard')">
        <div class="modal-dialog" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üìú <span id="standard-modal-title">Add Standard</span></h3>
                <button class="modal-close" onclick="closeModal('modal-standard')">√ó</button>
            </div>
            <form id="form-standard" onsubmit="saveStandard(event)">
                <input type="hidden" name="id" />
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Name <span class="required">*</span></label>
                            <input type="text" name="name" required placeholder="e.g. Require TLS 1.2 Minimum" />
                        </div>
                        <div class="form-group">
                            <label>Category <span class="required">*</span></label>
                            <select name="category">
                                <option value="encryption">Encryption</option>
                                <option value="identity">Identity</option>
                                <option value="network">Network</option>
                                <option value="monitoring">Monitoring</option>
                                <option value="tagging">Tagging</option>
                                <option value="geography">Geography</option>
                                <option value="cost">Cost</option>
                                <option value="compute">Compute</option>
                                <option value="data_protection">Data Protection</option>
                                <option value="operations">Operations</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" rows="2" placeholder="What this standard enforces and why..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Severity</label>
                            <select name="severity">
                                <option value="critical">üî¥ Critical</option>
                                <option value="high" selected>üü† High</option>
                                <option value="medium">üü° Medium</option>
                                <option value="low">üü¢ Low</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Scope <span class="hint">(resource type glob, * = all)</span></label>
                            <input type="text" name="scope" value="*" placeholder="e.g. Microsoft.Storage/*" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Rule (JSON)</label>
                        <textarea name="rule_json" rows="5" placeholder='{"type": "property", "key": "minTlsVersion", "operator": ">=", "value": "1.2", "remediation": "Set minTlsVersion to 1.2"}'></textarea>
                    </div>
                    <div class="form-group">
                        <label>Change Reason <span class="hint">(for version history)</span></label>
                        <input type="text" name="change_reason" placeholder="Why this change is being made..." />
                    </div>
                    <div class="form-group form-checkbox">
                        <label><input type="checkbox" name="enabled" checked /> Enabled</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-standard')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="btn-save-standard">Save Standard</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Standard Detail Drawer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="standard-detail-drawer" class="detail-drawer hidden">
        <div class="detail-drawer-header">
            <h3 id="detail-standard-name">Standard Name</h3>
            <button class="modal-close" onclick="closeStandardDetail()">√ó</button>
        </div>
        <div class="detail-drawer-body" id="detail-standard-body"></div>
    </div>

    <script src="/static/app.js?v=53"></script>

    <!-- ‚îÄ‚îÄ Template Viewer Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="modal-template-viewer" class="modal-overlay hidden" onclick="closeModalOnOverlay(event, 'modal-template-viewer')">
        <div class="modal-dialog modal-template-viewer-dialog" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üìÑ <span id="template-viewer-title">ARM Template</span></h3>
                <div class="template-viewer-actions">
                    <button class="btn btn-sm btn-secondary" onclick="copyTemplateToClipboard()" title="Copy to clipboard">üìã Copy</button>
                    <button class="btn btn-sm btn-secondary" onclick="downloadTemplate()" title="Download as JSON">‚¨á Download</button>
                    <button class="modal-close" onclick="closeModal('modal-template-viewer')">√ó</button>
                </div>
            </div>
            <div class="modal-body template-viewer-body">
                <div id="template-viewer-meta" class="template-viewer-meta"></div>
                <pre id="template-viewer-code" class="template-viewer-code"><code>Loading‚Ä¶</code></pre>
                <!-- Modification prompt -->
                <div id="template-modify-section" class="template-modify-section">
                    <div class="template-modify-header">
                        <span class="template-modify-label">‚úèÔ∏è Modify Template</span>
                        <span class="template-modify-hint">Describe your changes in plain English ‚Äî the LLM will apply them and create a new version</span>
                    </div>
                    <div class="template-modify-input-row">
                        <textarea id="template-modify-prompt" class="template-modify-prompt" rows="2" placeholder="e.g. Add a second subnet called 'data-subnet' with CIDR 10.0.2.0/24‚Ä¶"></textarea>
                        <button id="template-modify-btn" class="btn btn-primary template-modify-btn" onclick="submitTemplateModification()">
                            üöÄ Apply
                        </button>
                    </div>
                    <div id="template-modify-progress" class="template-modify-progress hidden"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
